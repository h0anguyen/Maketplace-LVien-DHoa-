extends ../layout

block content
    .page-wrapper
      include ../partials/header
      main.main.mt-5
        .page-content
          .container
            .row
              .col-lg-9
                .toolbox
                  .toolbox-left
                    .toolbox-info
                      | Hiển thị 
                      span #{products.length} của #{products.length}
                      |  Sản phẩm
                  .toolbox-right
                    .toolbox-sort
                      label(for='sortby') Sort by:
                      .select-custom
                        select#sortby.form-control(name='sortby')
                          option(value="rating") Most Popular
                          option(value='price-asc') Price: Low - High
                          option(value='price-desc') Price: High - Low
                .products.mb-3
                  .row.justify-content-start#product-container
                    if products.length > 0
                      each product in products
                        .col-md-4.col-lg-3.shadow-sm.mb-2.px-2
                          .product.product-7.text-center
                            figure.product-media
                              a(href=`/product/${product.id}`)
                                 img.product-image.hover-effect(src=`data:image/png;base64,${product.mainImage.toString('base64')}`, alt=`${product.productName}`)
                              .product-action
                                form(action='/cart' method='POST').addtocart
                                  input(type='hidden' name='productId' value=product.id)
                                  input(type='hidden' name='quantity' value='1')
                                  button.btn-product.btn-cart(type='submit' title='Thêm vào giỏ hàng')
                                    span Thêm vào giỏ hàng
                            .product-body
                              .product-cat
                                a(href=product.categories) #{product.categories}
                              h3.product-title
                                a(href=`/product/${product.id}`)
                                  | #{product.productName}
                              .product-price
                                | #{product.price}VNĐ
                              .sold.text-warning
                                | Đã bán: #{product.sold}
                      .text-center.mt-4
                        button#load-more.btn.btn-outline-primary-2 Xem thêm
                    else
                      .col-md-12.text-center
                        h3.text-dark.text-center Không tìm thấy sản phẩm nào phù hợp với từ khóa "#{searchQuery}"
              aside.col-lg-3.order-lg-first
                //- .sidebar.sidebar-shop
                //-   .widget.widget-clean
                //-     label 
                //-     a.sidebar-filter-clear(href='#') Clean All
                .widget.widget-collapsible
                  h3.widget-title
                    a(data-toggle='collapse' href='#widget-5' role='button' aria-expanded='true' aria-controls='widget-5')
                      | Bộ lọc
                  #widget-5.collapse.show
                    .widget-body
                      .filter-category
                        b.filer-category-text.md-2 
                          | Danh mục
                          each category in categories
                            .category-inputs.d-flex.align-items-center.mb-2.ml-4
                              - if(category.id==categoryId)
                                  a(href=`/category/${category.id}`).font-weight-border
                                    u= category.categoryName
                              - else
                                  a(href=`/category/${category.id}`).font-weight-normal.text-mutedza
                                    span= category.categoryName
                      //- .filter-address
                      //-   b.filter-address-text.mb-2
                      //-     | Nơi bán
                      //-   .address-inputs.d-flex.align-items-center.mb-2
                      //-     input(type="checkbox") 
      include ../partials/footer
    script.
      document.addEventListener('DOMContentLoaded', function() {
        let page = 1;
        const limit = 12; // Số sản phẩm mỗi lần load
        const loadMoreButton = document.getElementById('load-more');
        const productContainer = document.getElementById('product-container');
        
        // Lấy thông tin từ URL hiện tại
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('q');
        const categoryId = window.location.pathname.split('/').pop();

        loadMoreButton.addEventListener('click', function() {
          page++;
          let apiUrl = `/api/products/category/${categoryId}?page=${page}&limit=${limit}`;

          fetch(apiUrl)
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(data => {
              if (data && Array.isArray(data.products) && data.products.length > 0) {
                data.products.forEach(function(product) {
                  const productElement = document.createElement('div');
                  productElement.className = 'col-md-4 col-lg-3 shadow-sm mb-2 px-2';
                  productElement.innerHTML = `
                    <div class="product product-7 text-center">
                      <figure class="product-media">
                        <a href="/product/${product.id}">
                          <img class="product-image hover-effect" src="data:image/png;base64,${product.mainImage}" alt="${product.productName}">
                        </a>
                        <div class="product-action">
                          <form action="/cart" method="POST" class="addtocart">
                            <input type="hidden" name="productId" value="${product.id}">
                            <input type="hidden" name="quantity" value="1">
                            <button class="btn-product btn-cart" type="submit" title="Thêm vào giỏ hàng">
                              <span>Thêm vào giỏ hàng</span>
                            </button>
                          </form>
                        </div>
                      </figure>
                      <div class="product-body">
                        <div class="product-cat">
                          <a href="${product.categories}">${product.categories}</a>
                        </div>
                        <h3 class="product-title">
                          <a href="/product/${product.id}">${product.productName}</a>
                        </h3>
                        <div class="product-price">
                          ${product.price}VNĐ
                        </div>
                        <div class="sold text-warning">
                          Đã bán: ${product.sold}
                        </div>
                      </div>
                    </div>
                  `;
                  productContainer.appendChild(productElement);
                });
                
                if (data.products.length < limit) {
                  loadMoreButton.style.display = 'none';
                }
              } else {
                console.log('No more products to load or invalid data format');
                loadMoreButton.style.display = 'none';
              }
            })
            .catch(error => {
              console.error('Error loading more products:', error);
              loadMoreButton.style.display = 'none';
            });
        });
      });